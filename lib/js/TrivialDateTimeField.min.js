/*! Trivial Components | (c) 2015 Yann Massard and others | Apache License, Version 2.0 (https://raw.githubusercontent.com/trivial-components/trivial-components/master/LICENSE) */
!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd?define(["require","exports","jquery","moment","mustache","./TrivialCore","./TrivialEvent","./TrivialListBox","./TrivialCalendarBox","./TrivialDateSuggestionEngine","./TrivialTimeSuggestionEngine"],t):(window.TrivialComponents=window.TrivialComponents||{},t(function(t){return"jquery"===t?window.jQuery:"levenshtein"===t?window.Levenshtein:"moment"===t?window.moment:"mustache"===t?window.Mustache:window.TrivialComponents},window.TrivialComponents))}(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i,o=t("jquery"),n=t("moment"),r=t("mustache"),a=t("./TrivialCore"),s=t("./TrivialEvent"),d=t("./TrivialListBox"),l=t("./TrivialCalendarBox"),c=t("./TrivialDateSuggestionEngine"),h=t("./TrivialTimeSuggestionEngine");!function(t){t[t.MODE_CALENDAR=0]="MODE_CALENDAR",t[t.MODE_DATE_LIST=1]="MODE_DATE_LIST",t[t.MODE_TIME_LIST=2]="MODE_TIME_LIST"}(i||(i={}));var p=function(){function t(t,e){void 0===e&&(e={});var l=this;this.dateIconTemplate='<svg viewBox="0 0 540 540" width="22" height="22" class="calendar-icon">\n    <defs>\n        <linearGradient id="Gradient1" x1="0" x2="0" y1="0" y2="1">\n            <stop class="calendar-symbol-ring-gradient-stop1" offset="0%"/>\n            <stop class="calendar-symbol-ring-gradient-stop2" offset="50%"/>\n            <stop class="calendar-symbol-ring-gradient-stop3" offset="100%"/>\n        </linearGradient>\n    </defs>        \n    <g id="layer1">\n        <rect class="calendar-symbol-page-background" x="90" y="90" width="360" height="400" ry="3.8"></rect>\n        <rect class="calendar-symbol-color" x="90" y="90" width="360" height="100" ry="3.5"></rect>\n        <rect class="calendar-symbol-page" x="90" y="90" width="360" height="395" ry="3.8"></rect>\n        <rect class="calendar-symbol-ring" fill="url(#Gradient2)" x="140" y="30" width="40" height="120" ry="30.8"></rect>\n        <rect class="calendar-symbol-ring" fill="url(#Gradient2)" x="250" y="30" width="40" height="120" ry="30.8"></rect>\n        <rect class="calendar-symbol-ring" fill="url(#Gradient2)" x="360" y="30" width="40" height="120" ry="30.8"></rect>\n        <text class="calendar-symbol-date" x="270" y="415" text-anchor="middle">{{weekDay}}</text>\n    </g>\n</svg>',this.dateTemplate='<div class="tr-template-icon-single-line">'+this.dateIconTemplate+'<div class="content-wrapper tr-editor-area">{{displayString}}</div></div>',this.timeIconTemplate='<svg class="clock-icon night-{{isNight}}" viewBox="0 0 110 110" width="22" height="22"> <circle class="clockcircle" cx="55" cy="55" r="45"/><g class="hands"> <line class="hourhand" x1="55" y1="55" x2="55" y2="35" {{#hourAngle}}transform="rotate({{hourAngle}},55,55)"{{/hourAngle}}/>  <line class="minutehand" x1="55" y1="55" x2="55" y2="22" {{#minuteAngle}}transform="rotate({{minuteAngle}},55,55)"{{/minuteAngle}}/></g> </svg>',this.timeTemplate='<div class="tr-template-icon-single-line">'+this.timeIconTemplate+'  <div class="content-wrapper tr-editor-area">{{displayString}}</div></div>',this.onChange=new s.TrivialEvent(this),this.isDropDownOpen=!1,this.dateValue=null,this.timeValue=null,this.blurCausedByClickInsideComponent=!1,this.focusGoesToOtherEditor=!1,this.autoCompleteTimeoutId=-1,this.doNoAutoCompleteBecauseBackspaceWasPressed=!1,this.calendarBoxInitialized=!1,this.dropDownMode=i.MODE_CALENDAR,e=e||{},this.config=o.extend({dateFormat:"MM/DD/YYYY",timeFormat:"HH:mm",autoComplete:!0,autoCompleteDelay:0,showTrigger:!0,editingMode:"editable"},e),this.$originalInput=o(t).addClass("tr-original-input"),this.$dateTimeField=o('<div class="tr-datetimefield tr-input-wrapper"/>').addClass(this.config.editingMode).insertAfter(this.$originalInput);var p=o('<div class="tr-editor-wrapper">').appendTo(this.$dateTimeField);if(this.$dateIconWrapper=o('<div class="tr-date-icon-wrapper"/>').appendTo(p),this.$dateEditor=o('<div class="tr-date-editor" contenteditable="true"/>').appendTo(p),this.$timeIconWrapper=o('<div class="tr-time-icon-wrapper"/>').appendTo(p),this.$timeEditor=o('<div class="tr-time-editor" contenteditable="true"/>').appendTo(p),this.$dateIconWrapper.click(function(){l.$activeEditor=l.$dateEditor,l.setDropDownMode(i.MODE_CALENDAR),l.openDropDown(),a.selectElementContents(l.$dateEditor[0],0,l.$dateEditor.text().length)}),this.$timeIconWrapper.click(function(){l.$activeEditor=l.$timeEditor,l.setDropDownMode(i.MODE_CALENDAR),a.selectElementContents(l.$timeEditor[0],0,l.$timeEditor.text().length)}),this.$dateEditor.focus(function(){l.$activeEditor=l.$dateEditor,l.blurCausedByClickInsideComponent&&!l.focusGoesToOtherEditor||a.selectElementContents(l.$dateEditor[0],0,l.$dateEditor.text().length)}),this.$timeEditor.focus(function(){l.$activeEditor=l.$timeEditor,l.blurCausedByClickInsideComponent&&!l.focusGoesToOtherEditor||a.selectElementContents(l.$timeEditor[0],0,l.$timeEditor.text().length)}),this.config.showTrigger){var u=o('<div class="tr-trigger"><span class="tr-trigger-icon"/></div>').appendTo(this.$dateTimeField);u.mousedown(function(){l.isDropDownOpen?l.closeDropDown():setTimeout(function(){l.setDropDownMode(i.MODE_CALENDAR),l.calendarBox.setSelectedDate(l.dateValue?l.dateValue.moment:n()),l.$activeEditor=l.$dateEditor,a.selectElementContents(l.$dateEditor[0],0,l.$dateEditor.text().length),l.openDropDown()})})}this.$dropDown=o('<div class="tr-dropdown"></div>').scroll(function(){return!1}),this.dropdownNeeded="editable"==this.config.editingMode,this.dropdownNeeded&&this.$dropDown.appendTo("body");var m=o('<div class="date-listbox">').appendTo(this.$dropDown);this.dateListBox=new d.TrivialListBox(m,{entryRenderingFunction:function(t){return r.render(l.dateTemplate,t)}}),this.dateListBox.onSelectedEntryChanged.addListener(function(t){t&&(l.setDate(t,t.displayString!=(l.dateValue&&l.dateValue.displayString)),l.dateListBox.setSelectedEntry(null),l.closeDropDown())});var g=o('<div class="time-listbox">').appendTo(this.$dropDown);this.timeListBox=new d.TrivialListBox(g,{entryRenderingFunction:function(t){return r.render(l.timeTemplate,t)}}),this.timeListBox.onSelectedEntryChanged.addListener(function(t){t&&(l.setTime(t,t.displayString!=(l.timeValue&&l.timeValue.displayString)),l.dateListBox.setSelectedEntry(null),l.closeDropDown())}),this.$calendarBox=o('<div class="calendarbox">').appendTo(this.$dropDown),this.$dateEditor.add(this.$timeEditor).focus(function(){l.$dateTimeField.addClass("focus")}).blur(function(){l.blurCausedByClickInsideComponent||(l.$dateTimeField.removeClass("focus"),l.updateDisplay(),l.closeDropDown())}).keydown(function(t){if(!a.keyCodes.isModifierKey(t)){if(t.which==a.keyCodes.tab)return void l.selectHighlightedListBoxEntry();if(t.which==a.keyCodes.left_arrow||t.which==a.keyCodes.right_arrow)return void(l.getActiveEditor()===l.$timeEditor&&t.which==a.keyCodes.left_arrow&&0===window.getSelection().focusOffset?(t.preventDefault(),a.selectElementContents(l.$dateEditor[0],0,l.$dateEditor.text().length)):l.getActiveEditor()===l.$dateEditor&&t.which==a.keyCodes.right_arrow&&window.getSelection().focusOffset===l.$dateEditor.text().length&&(t.preventDefault(),a.selectElementContents(l.$timeEditor[0],0,l.$timeEditor.text().length)));if(t.which!=a.keyCodes.backspace&&t.which!=a.keyCodes.delete||(l.doNoAutoCompleteBecauseBackspaceWasPressed=!0),t.which==a.keyCodes.up_arrow||t.which==a.keyCodes.down_arrow){l.getActiveEditor().select();var e=t.which==a.keyCodes.up_arrow?-1:1;return l.isDropDownOpen?(l.setDropDownMode(t.currentTarget===l.$dateEditor[0]?i.MODE_DATE_LIST:i.MODE_TIME_LIST),l.query(e),l.openDropDown()):l.dropDownMode!==i.MODE_CALENDAR&&(l.getActiveBox().navigate(1===e?"down":"up"),l.autoCompleteIfPossible(l.config.autoCompleteDelay)),!1}t.which==a.keyCodes.enter?l.isDropDownOpen&&(t.preventDefault(),l.selectHighlightedListBoxEntry(),a.selectElementContents(l.getActiveEditor()[0],0,l.getActiveEditor().text().length),l.closeDropDown()):t.which==a.keyCodes.escape?(t.preventDefault(),l.isDropDownOpen&&(l.updateDisplay(),a.selectElementContents(l.getActiveEditor()[0],0,l.getActiveEditor().text().length)),l.closeDropDown()):(l.setDropDownMode(t.currentTarget===l.$dateEditor[0]?i.MODE_DATE_LIST:i.MODE_TIME_LIST),l.query(1),l.openDropDown())}}),this.$originalInput.val()?this.setValue(n(this.$originalInput.val())):this.setValue(null),this.$originalInput.attr("tabindex")&&this.$dateEditor.add(this.$timeEditor).attr("tabindex",this.$originalInput.attr("tabindex")),this.$originalInput.attr("autofocus")&&this.$dateEditor.focus(),this.$dateTimeField.add(this.$dropDown).mousedown(function(t){(l.$dateEditor.is(":focus")||l.$timeEditor.is(":focus"))&&(l.blurCausedByClickInsideComponent=!0),t.target!==l.$dateEditor[0]&&t.target!==l.$timeEditor[0]&&t.target!==l.$dateIconWrapper[0]&&t.target!==l.$timeIconWrapper[0]||(l.focusGoesToOtherEditor=!0)}).on("mouseup mouseout",function(){l.blurCausedByClickInsideComponent&&!l.focusGoesToOtherEditor&&l.getActiveEditor().focus(),l.blurCausedByClickInsideComponent=!1,l.focusGoesToOtherEditor=!1}),this.$activeEditor=this.$dateEditor,this.dateSuggestionEngine=new c.TrivialDateSuggestionEngine({preferredDateFormat:this.config.dateFormat}),this.timeSuggestionEngine=new h.TrivialTimeSuggestionEngine}return t.prototype.setDropDownMode=function(e){var n=this;this.dropDownMode=e,this.calendarBoxInitialized||e!==i.MODE_CALENDAR||(this.calendarBox=new l.TrivialCalendarBox(this.$calendarBox,{firstDayOfWeek:1,mode:"date"}),this.calendarBox.setKeyboardNavigationState("month"),this.calendarBox.onChange.addListener(function(e){var i=e.value,o=e.timeUnitEdited;n.setDate(t.createDateComboBoxEntry(i,n.config.dateFormat)),"day"===o&&(n.closeDropDown(),n.$activeEditor=n.$timeEditor,a.selectElementContents(n.$timeEditor[0],0,n.$timeEditor.text().length),n.fireChangeEvents())}),this.calendarBoxInitialized=!0),this.calendarBoxInitialized&&o(this.calendarBox.getMainDomElement()).toggle(e===i.MODE_CALENDAR),o(this.dateListBox.getMainDomElement()).toggle(e===i.MODE_DATE_LIST),o(this.timeListBox.getMainDomElement()).toggle(e===i.MODE_TIME_LIST)},t.prototype.getActiveBox=function(){return this.dropDownMode===i.MODE_CALENDAR?this.calendarBox:this.dropDownMode===i.MODE_DATE_LIST?this.dateListBox:this.timeListBox},t.prototype.getActiveEditor=function(){return this.$activeEditor},t.prototype.selectHighlightedListBoxEntry=function(){if(this.dropDownMode===i.MODE_DATE_LIST||this.dropDownMode===i.MODE_TIME_LIST){var t=this.getActiveBox().getHighlightedEntry();this.isDropDownOpen&&t&&(this.getActiveEditor()===this.$dateEditor?this.setDate(t,!0):this.setTime(t,!0))}},t.prototype.query=function(e){var i=this;setTimeout(function(){var o=i.getNonSelectedEditorValue();if(i.getActiveEditor()===i.$dateEditor){var r=i.dateSuggestionEngine.generateSuggestions(o,n()).map(function(e){return t.createDateComboBoxEntry(e.moment,i.config.dateFormat)});i.updateEntries(r,e)}else{var r=i.timeSuggestionEngine.generateSuggestions(o).map(function(e){return t.createTimeComboBoxEntry(e.hour,e.minute,i.config.timeFormat)});i.updateEntries(r,e)}},0)},t.prototype.getValue=function(){return null==this.dateValue&&null==this.timeValue?null:null==this.dateValue?null:null==this.timeValue?n([this.dateValue.year,this.dateValue.month-1,this.dateValue.day]).startOf("day"):n([this.dateValue.year,this.dateValue.month-1,this.dateValue.day,this.timeValue.hour,this.timeValue.minute])},t.prototype.fireChangeEvents=function(){this.$originalInput.trigger("change"),this.onChange.fire(this.getValue())},t.prototype.setDate=function(t,e){void 0===e&&(e=!1),this.dateValue=t,this.updateDisplay(),e&&this.fireChangeEvents()},t.prototype.setTime=function(t,e){void 0===e&&(e=!1),this.timeValue=t,this.updateDisplay(),e&&this.fireChangeEvents()},t.prototype.updateDisplay=function(){this.dateValue?(this.$dateEditor.text(n([this.dateValue.year,this.dateValue.month-1,this.dateValue.day]).format(this.config.dateFormat)),this.$dateIconWrapper.empty().append(r.render(this.dateIconTemplate,this.dateValue))):(this.$dateEditor.text(""),this.$dateIconWrapper.empty().append(r.render(this.dateIconTemplate,{}))),this.timeValue?(this.$timeEditor.text(n([1970,0,1,this.timeValue.hour,this.timeValue.minute]).format(this.config.timeFormat)),this.$timeIconWrapper.empty().append(r.render(this.timeIconTemplate,this.timeValue))):(this.$timeEditor.text(""),this.$timeIconWrapper.empty().append(r.render(this.timeIconTemplate,{})))},t.prototype.setValue=function(e){this.setDate(e&&t.createDateComboBoxEntry(e,this.config.dateFormat)),this.setTime(e&&t.createTimeComboBoxEntry(e.hour(),e.minute(),this.config.timeFormat))},t.prototype.repositionDropDown=function(){var t=this;this.$dropDown.show().position({my:"left top",at:"left bottom",of:this.$dateTimeField,collision:"flip",using:function(e,i){"top"===i.vertical?(t.$dateTimeField.removeClass("dropdown-flipped"),t.$dropDown.removeClass("flipped")):(t.$dateTimeField.addClass("dropdown-flipped"),t.$dropDown.addClass("flipped")),t.$dropDown.css({left:e.left+"px",top:e.top+"px"})}}).width(this.$dateTimeField.width())},t.prototype.openDropDown=function(){this.dropdownNeeded&&(this.$dateTimeField.addClass("open"),this.repositionDropDown(),this.isDropDownOpen=!0)},t.prototype.closeDropDown=function(){this.$dateTimeField.removeClass("open"),this.$dropDown.hide(),this.isDropDownOpen=!1},t.prototype.getNonSelectedEditorValue=function(){var t=this.getActiveEditor().text().replace(String.fromCharCode(160)," "),e=window.getSelection();return e.anchorOffset!=e.focusOffset?t.substring(0,Math.min(e.anchorOffset,e.focusOffset)):t},t.prototype.autoCompleteIfPossible=function(t){var e=this;if(this.config.autoComplete&&(this.dropDownMode===i.MODE_DATE_LIST||this.dropDownMode===i.MODE_TIME_LIST)){clearTimeout(this.autoCompleteTimeoutId);var o=this.getActiveBox(),n=o.getHighlightedEntry();if(n&&this.doNoAutoCompleteBecauseBackspaceWasPressed){var r=n.displayString;r&&(this.autoCompleteTimeoutId=window.setTimeout(function(){var t,i=e.getNonSelectedEditorValue();t=0===r.toLowerCase().indexOf(i.toLowerCase())?i+r.substr(i.length):e.getNonSelectedEditorValue(),e.getActiveEditor().text(t),e.getActiveEditor().is(":focus")&&a.selectElementContents(e.getActiveEditor()[0],i.length,t.length)},t||0))}this.doNoAutoCompleteBecauseBackspaceWasPressed=!1}},t.prototype.updateEntries=function(t,e){var i=this.getActiveBox();e=void 0===e?1:e,i.updateEntries(t),i.highlightTextMatches(this.getNonSelectedEditorValue()),i.highlightNextEntry(e),this.autoCompleteIfPossible(this.config.autoCompleteDelay),this.isDropDownOpen&&this.openDropDown()},t.createTimeComboBoxEntry=function(e,i,o){return{hour:e,minute:i,hourString:t.pad(e,2),minuteString:t.pad(i,2),displayString:n().hour(e).minute(i).format(o),hourAngle:30*(e%12+i/60),minuteAngle:6*i,isNight:e<6||e>=20}},t.pad=function(t,e){for(var i=t+"";i.length<e;)i="0"+i;return i},t.createDateComboBoxEntry=function(t,e){return{moment:t,day:t.date(),weekDay:t.format("dd"),month:t.month()+1,year:t.year(),displayString:t.format(e)}},t.prototype.focus=function(){a.selectElementContents(this.getActiveEditor()[0],0,this.getActiveEditor().text().length)},t.prototype.destroy=function(){this.$originalInput.removeClass("tr-original-input").insertBefore(this.$dateTimeField),this.$dateTimeField.remove(),this.$dropDown.remove()},t.prototype.getMainDomElement=function(){return this.$dateTimeField[0]},t}();e.TrivialDateTimeField=p});