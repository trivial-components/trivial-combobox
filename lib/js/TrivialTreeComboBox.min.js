/*! Trivial Components | (c) 2015 Yann Massard and others | Apache License, Version 2.0 (https://raw.githubusercontent.com/trivial-components/trivial-components/master/LICENSE) */
!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd?define(["require","exports","jquery","mustache","./TrivialCore","./TrivialTreeBox","./TrivialEvent"],e):(window.TrivialComponents=window.TrivialComponents||{},e(function(e){return"jquery"===e?window.jQuery:"levenshtein"===e?window.Levenshtein:"moment"===e?window.moment:"mustache"===e?window.Mustache:window.TrivialComponents},window.TrivialComponents))}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=e("jquery"),i=e("mustache"),n=e("./TrivialCore"),r=e("./TrivialTreeBox"),s=e("./TrivialEvent"),l=function(){function e(e,t){void 0===t&&(t={});var l=this;this.isDropDownOpen=!1,this.isEditorVisible=!1,this.selectedEntry=null,this.lastCommittedValue=null,this.blurCausedByClickInsideComponent=!1,this.autoCompleteTimeoutId=-1,this.doNoAutoCompleteBecauseBackspaceWasPressed=!1,this.usingDefaultQueryFunction=!1,this.$spinners=o(),this.onSelectedEntryChanged=new s.TrivialEvent(this),this.onFocus=new s.TrivialEvent(this),this.onBlur=new s.TrivialEvent(this),this.config=o.extend({valueFunction:function(e){return e?""+e.id:null},entryRenderingFunction:function(e,t){var o=[n.DEFAULT_TEMPLATES.icon2LinesTemplate,n.DEFAULT_TEMPLATES.iconSingleLineTemplate],r=o[Math.min(t,o.length-1)];return i.render(r,e)},selectedEntryRenderingFunction:function(e){return l.config.entryRenderingFunction(e,0)},selectedEntry:null,spinnerTemplate:n.DEFAULT_TEMPLATES.defaultSpinnerTemplate,noEntriesTemplate:n.DEFAULT_TEMPLATES.defaultNoEntriesTemplate,textHighlightingEntryLimit:100,entries:null,queryFunction:null,autoComplete:!0,autoCompleteDelay:0,entryToEditorTextFunction:function(e){return e.displayValue},autoCompleteFunction:function(e,t){if(e){for(var o in t){var i=t[o];if(i&&0===i.toString().toLowerCase().indexOf(e.toLowerCase()))return i.toString()}return null}return t?l.config.entryToEditorTextFunction(t):null},allowFreeText:!1,freeTextEntryFactory:function(e){return{displayValue:e,_isFreeTextEntry:!0}},showClearButton:!1,showTrigger:!0,matchingOptions:{matchingMode:"contains",ignoreCase:!0,maxLevenshteinDistance:2},childrenProperty:"children",lazyChildrenFlagProperty:"hasLazyChildren",expandedProperty:"expanded",editingMode:"editable",showDropDownOnResultsOnly:!1},t),this.config.queryFunction||(this.config.queryFunction=n.defaultTreeQueryFunctionFactory(this.config.entries||[],n.defaultEntryMatchingFunctionFactory(["displayValue","additionalInfo"],this.config.matchingOptions),this.config.childrenProperty,this.config.expandedProperty),this.usingDefaultQueryFunction=!0),this.$originalInput=o(e),this.$treeComboBox=o('<div class="tr-treecombobox tr-combobox tr-input-wrapper"/>').insertAfter(this.$originalInput),this.$selectedEntryWrapper=o('<div class="tr-combobox-selected-entry-wrapper"/>').appendTo(this.$treeComboBox),this.config.showClearButton&&(this.$clearButton=o('<div class="tr-remove-button">').appendTo(this.$treeComboBox),this.$clearButton.mousedown(function(e){l.$editor.val(""),l.setSelectedEntry(null,!0,!0,e)})),this.config.showTrigger&&(this.$trigger=o('<div class="tr-trigger"><span class="tr-trigger-icon"/></div>').appendTo(this.$treeComboBox),this.$trigger.mousedown(function(){l.isDropDownOpen?(l.showEditor(),l.closeDropDown()):setTimeout(function(){l.showEditor(),l.$editor.select(),l.openDropDown(),l.query()})})),this.$dropDown=o('<div class="tr-dropdown"></div>').scroll(function(){return!1}),this.$dropDownTargetElement=o("body"),this.setEditingMode(this.config.editingMode),this.$originalInput.addClass("tr-original-input"),this.$editor=o('<input type="text" autocomplete="off"/>'),this.$editor.prependTo(this.$treeComboBox).addClass("tr-combobox-editor tr-editor").focus(function(){l.blurCausedByClickInsideComponent||(l.$originalInput.triggerHandler("focus"),l.onFocus.fire(),l.$treeComboBox.addClass("focus"),l.showEditor())}).blur(function(e){l.blurCausedByClickInsideComponent?l.$editor.focus():(l.$originalInput.triggerHandler("blur"),l.onBlur.fire(),l.$treeComboBox.removeClass("focus"),l.editorContainsFreeText()?n.objectEquals(l.getSelectedEntry(),l.lastCommittedValue)||l.setSelectedEntry(l.getSelectedEntry(),!0,!0,e):(l.$editor.val(""),l.setSelectedEntry(l.lastCommittedValue,!1,!1,e)),l.hideEditor(),l.closeDropDown())}).keydown(function(e){if(!n.keyCodes.isModifierKey(e)){if(e.which==n.keyCodes.tab){var t=l.treeBox.getHighlightedEntry();return void(l.isDropDownOpen&&t?l.setSelectedEntry(t,!0,!0,e):l.$editor.val()?l.config.allowFreeText&&l.setSelectedEntry(l.getSelectedEntry(),!0,!0,e):l.setSelectedEntry(null,!0,!0,e))}if(e.which==n.keyCodes.left_arrow||e.which==n.keyCodes.right_arrow){if(l.isDropDownOpen){var o=l.treeBox.setHighlightedNodeExpanded(e.which==n.keyCodes.right_arrow);if(o)return!1}return void l.showEditor()}if(setTimeout(function(){var t=!n.keyCodes.isModifierKey(e)&&[n.keyCodes.enter,n.keyCodes.escape,n.keyCodes.tab].indexOf(e.which)===-1,o=l.isEntrySelected()&&l.$editor.val()!==l.config.entryToEditorTextFunction(l.selectedEntry);t&&(o||l.config.valueFunction(l.treeBox.getHighlightedEntry()))!==l.config.valueFunction(l.getSelectedEntry())&&l.setSelectedEntry(null,!1,!1,e)}),e.which!=n.keyCodes.backspace&&e.which!=n.keyCodes.delete||(l.doNoAutoCompleteBecauseBackspaceWasPressed=!0),e.which==n.keyCodes.up_arrow||e.which==n.keyCodes.down_arrow){l.isEditorVisible||(l.$editor.select(),l.showEditor());var i=e.which==n.keyCodes.up_arrow?-1:1;return l.isDropDownOpen?(l.treeBox.highlightNextEntry(i),l.autoCompleteIfPossible(l.config.autoCompleteDelay)):(l.query(i),l.openDropDown()),!1}if(e.which==n.keyCodes.enter){if(l.isEditorVisible||l.editorContainsFreeText()){e.preventDefault();var t=l.treeBox.getHighlightedEntry();l.isDropDownOpen&&t?l.setSelectedEntry(t,!0,!0,e):l.$editor.val()?l.config.allowFreeText&&l.setSelectedEntry(l.getSelectedEntry(),!0,!0,e):l.setSelectedEntry(null,!0,!0,e),l.closeDropDown(),l.hideEditor()}}else e.which==n.keyCodes.escape?(e.preventDefault(),l.editorContainsFreeText()&&l.isDropDownOpen||(l.hideEditor(),l.$editor.val(""),l.setSelectedEntry(l.lastCommittedValue,!1,!1,e)),l.closeDropDown()):(l.isEditorVisible||(l.showEditor(),l.$editor.select()),l.config.showDropDownOnResultsOnly||l.openDropDown(),setTimeout(function(){l.$editor.val()?l.query(1):(l.query(0),l.treeBox.setHighlightedEntry(null))}))}}).mousedown(function(){l.config.showDropDownOnResultsOnly||l.openDropDown(),l.query()}),this.$originalInput.attr("tabindex")&&this.$editor.attr("tabindex",this.$originalInput.attr("tabindex")),this.$originalInput.attr("autofocus")&&this.$editor.focus(),this.$treeComboBox.add(this.$dropDown).mousedown(function(){l.$editor.is(":focus")&&(l.blurCausedByClickInsideComponent=!0)}).mouseup(function(){l.blurCausedByClickInsideComponent&&(l.$editor.focus(),l.blurCausedByClickInsideComponent=!1)}).mouseout(function(){l.blurCausedByClickInsideComponent&&(l.$editor.focus(),l.blurCausedByClickInsideComponent=!1)}),this.treeBox=new r.TrivialTreeBox(this.$dropDown,this.config),this.treeBox.onSelectedEntryChanged.addListener(function(e,t,o){e&&(l.setSelectedEntry(e,!0,!n.objectEquals(e,l.lastCommittedValue),o),l.treeBox.setSelectedEntry(null),l.closeDropDown()),l.hideEditor()}),this.setSelectedEntry(this.config.selectedEntry,!0,!1,null),this.$selectedEntryWrapper.click(function(){l.showEditor(),l.$editor.select(),l.config.showDropDownOnResultsOnly||l.openDropDown(),l.query()})}return e.prototype.query=function(e){var t=this;if(0===this.$spinners.length){var i=o(this.config.spinnerTemplate).appendTo(this.$dropDown);this.$spinners=this.$spinners.add(i)}this.config.queryFunction(this.getNonSelectedEditorValue(),function(o){t.updateEntries(o,e),t.config.showDropDownOnResultsOnly&&o&&o.length>0&&t.$editor.is(":focus")&&t.openDropDown()})},e.prototype.fireChangeEvents=function(e,t){this.$originalInput.trigger("change"),this.onSelectedEntryChanged.fire(e,t)},e.prototype.setSelectedEntry=function(e,t,i,n){this.$originalInput.val(this.config.valueFunction(e)),this.selectedEntry=e;var r=o(this.config.selectedEntryRenderingFunction(e)).addClass("tr-combobox-entry");this.$selectedEntryWrapper.empty().append(r),null!=e&&this.$editor.val(this.config.entryToEditorTextFunction(e)),t&&(this.lastCommittedValue=e,i&&this.fireChangeEvents(e,n)),this.$clearButton&&this.$clearButton.toggle(null!=e),this.isEditorVisible&&this.showEditor(),this.isDropDownOpen&&this.repositionDropDown()},e.prototype.isEntrySelected=function(){return null!=this.selectedEntry},e.prototype.showEditor=function(){var e=this.$selectedEntryWrapper.find(".tr-editor-area");0===e.length&&(e=this.$selectedEntryWrapper),this.$editor.css({width:Math.min(e[0].offsetWidth,this.$trigger?this.$trigger[0].offsetLeft-e[0].offsetLeft:99999999)+"px",height:e[0].offsetHeight+"px"}).position({my:"left top",at:"left top",of:e}),this.isEditorVisible=!0},e.prototype.editorContainsFreeText=function(){return this.config.allowFreeText&&this.$editor.val().length>0&&!this.isEntrySelected()},e.prototype.hideEditor=function(){this.$editor.width(0).height(0),this.isEditorVisible=!1},e.prototype.repositionDropDown=function(){var e=this;this.$dropDown.show().position({my:"left top",at:"left bottom",of:this.$treeComboBox,collision:"flip",using:function(t,o){"top"===o.vertical?(e.$treeComboBox.removeClass("dropdown-flipped"),e.$dropDown.removeClass("flipped")):(e.$treeComboBox.addClass("dropdown-flipped"),e.$dropDown.addClass("flipped")),e.$dropDown.css({left:t.left+"px",top:t.top+"px"})}}).width(this.$treeComboBox.width())},e.prototype.openDropDown=function(){this.isDropDownNeeded()&&(this.$treeComboBox.addClass("open"),this.repositionDropDown(),this.isDropDownOpen=!0)},e.prototype.closeDropDown=function(){this.$treeComboBox.removeClass("open"),this.$dropDown.hide(),this.isDropDownOpen=!1},e.prototype.getNonSelectedEditorValue=function(){return this.$editor.val().substring(0,this.$editor[0].selectionStart)},e.prototype.autoCompleteIfPossible=function(e){var t=this;if(this.config.autoComplete){clearTimeout(this.autoCompleteTimeoutId);var o=this.treeBox.getHighlightedEntry();o&&!this.doNoAutoCompleteBecauseBackspaceWasPressed&&(this.autoCompleteTimeoutId=n.setTimeoutOrDoImmediately(function(){var e=t.getNonSelectedEditorValue(),i=t.config.autoCompleteFunction(e,o)||e;t.$editor.val(e+i.substr(e.length)),t.$editor.is(":focus")&&t.$editor[0].setSelectionRange(e.length,i.length)},e)),this.doNoAutoCompleteBecauseBackspaceWasPressed=!1}},e.prototype.updateEntries=function(e,t){this.blurCausedByClickInsideComponent=!1,this.$spinners.remove(),this.$spinners=o(),this.treeBox.updateEntries(e);var i=this.getNonSelectedEditorValue();this.treeBox.highlightTextMatches(e.length<=this.config.textHighlightingEntryLimit?i:null),null==t?this.selectedEntry?this.treeBox.setHighlightedEntry(null):i.length>0?this.treeBox.highlightNextMatchingEntry(1):this.treeBox.highlightNextEntry(1):0===t?this.treeBox.setHighlightedEntry(null):i.length>0?this.treeBox.highlightNextMatchingEntry(1):this.treeBox.highlightNextEntry(1),this.autoCompleteIfPossible(this.config.autoCompleteDelay),this.isDropDownOpen&&this.openDropDown()},e.prototype.isDropDownNeeded=function(){return"editable"==this.editingMode&&(this.config.entries&&this.config.entries.length>0||!this.usingDefaultQueryFunction||this.config.showTrigger)},e.prototype.setEditingMode=function(e){this.editingMode=e,this.$treeComboBox.removeClass("editable readonly disabled").addClass(this.editingMode),this.isDropDownNeeded()&&this.$dropDown.appendTo(this.$dropDownTargetElement)},e.prototype.getSelectedEntry=function(){if(null!=this.selectedEntry||this.config.allowFreeText&&this.$editor.val()){if(null==this.selectedEntry&&this.config.allowFreeText)return this.config.freeTextEntryFactory(this.$editor.val());var e=o.extend({},this.selectedEntry);return delete e._trEntryElement,e}return null},e.prototype.updateChildren=function(e,t){this.treeBox.updateChildren(e,t)},e.prototype.updateNode=function(e){this.treeBox.updateNode(e)},e.prototype.removeNode=function(e){this.treeBox.removeNode(e)},e.prototype.focus=function(){this.showEditor(),this.$editor.select()},e.prototype.getEditor=function(){return this.$editor[0]},e.prototype.getDropDown=function(){return this.$dropDown},e.prototype.destroy=function(){this.$originalInput.removeClass("tr-original-input").insertBefore(this.$treeComboBox),this.$treeComboBox.remove(),this.$dropDown.remove()},e.prototype.getMainDomElement=function(){return this.$treeComboBox[0]},e}();t.TrivialTreeComboBox=l});