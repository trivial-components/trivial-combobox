/*! Trivial Components | (c) 2015 Yann Massard and others | Apache License, Version 2.0 (https://raw.githubusercontent.com/trivial-components/trivial-components/master/LICENSE) */
!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd?define(["require","exports","jquery","mustache","./TrivialListBox","./TrivialCore","./TrivialEvent"],t):(window.TrivialComponents=window.TrivialComponents||{},t(function(t){return"jquery"===t?window.jQuery:"levenshtein"===t?window.Levenshtein:"moment"===t?window.moment:"mustache"===t?window.Mustache:window.TrivialComponents},window.TrivialComponents))}(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=t("jquery"),n=t("mustache"),o=t("./TrivialListBox"),r=t("./TrivialCore"),s=t("./TrivialEvent"),l=function(){function t(t,e){void 0===e&&(e={});var l=this;this.$spinners=i(),this.onSelectedEntryChanged=new s.TrivialEvent(this),this.onFocus=new s.TrivialEvent(this),this.onBlur=new s.TrivialEvent(this),this.isDropDownOpen=!1,this.lastQueryString=null,this.lastCompleteInputQueryString=null,this.selectedEntries=[],this.blurCausedByClickInsideComponent=!1,this.autoCompleteTimeoutId=-1,this.doNoAutoCompleteBecauseBackspaceWasPressed=!1,this.listBoxDirty=!0,this.repositionDropDownScheduler=null,this.config=i.extend({valueFunction:function(t){return t.map(function(t){return t._isFreeTextEntry?t.displayValue:t.id}).join(",")},entryRenderingFunction:function(t){return n.render(r.DEFAULT_TEMPLATES.image2LinesTemplate,t)},selectedEntryRenderingFunction:function(t){return r.wrapWithDefaultTagWrapper(l.config.entryRenderingFunction(t))},spinnerTemplate:r.DEFAULT_TEMPLATES.defaultSpinnerTemplate,noEntriesTemplate:r.DEFAULT_TEMPLATES.defaultNoEntriesTemplate,textHighlightingEntryLimit:100,entries:null,selectedEntries:[],maxSelectedEntries:null,queryFunction:null,autoComplete:!0,autoCompleteDelay:0,autoCompleteFunction:function(t,e){if(t){for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];if(n&&0===(""+n).toLowerCase().indexOf(t.toLowerCase()))return""+n}return null}return null},allowFreeText:!1,freeTextSeparators:[",",";"],freeTextEntryFactory:function(t){return{displayValue:t,_isFreeTextEntry:!0}},tagCompleteDecider:function(t){return!0},entryMerger:function(t,e){return e},removePartialTagOnBlur:!0,showTrigger:!0,distinct:!0,matchingOptions:{matchingMode:"contains",ignoreCase:!0,maxLevenshteinDistance:2},editingMode:"editable",showDropDownOnResultsOnly:!1,selectionAcceptor:function(t){return!0}},e),this.config.queryFunction||(this.config.queryFunction=r.defaultListQueryFunctionFactory(this.config.entries||[],this.config.matchingOptions),this.usingDefaultQueryFunction=!0),this.entries=this.config.entries,this.$originalInput=i(t).addClass("tr-original-input"),this.$tagComboBox=i('<div class="tr-tagbox tr-input-wrapper"/>').insertAfter(this.$originalInput),this.$originalInput.appendTo(this.$tagComboBox),this.$tagArea=i('<div class="tr-tagbox-tagarea"/>').appendTo(this.$tagComboBox),this.config.showTrigger&&(this.$trigger=i('<div class="tr-trigger"><span class="tr-trigger-icon"/></div>').appendTo(this.$tagComboBox),this.$trigger.mousedown(function(){l.focusEditor(),l.isDropDownOpen?l.closeDropDown():(l.$editor.select(),l.openDropDown(),l.query())})),this.$dropDown=i('<div class="tr-dropdown"></div>').scroll(function(){return!1}),this.$dropDownTargetElement=i("body"),this.setEditingMode(this.config.editingMode),this.$editor=i('<span contenteditable="true" class="tagbox-editor" autocomplete="off"></span>'),this.$editor.appendTo(this.$tagArea).addClass("tr-tagbox-editor tr-editor").focus(function(){l.blurCausedByClickInsideComponent||(l.$originalInput.triggerHandler("focus"),l.onFocus.fire(),l.$tagComboBox.addClass("focus")),setTimeout(function(){r.minimallyScrollTo(l.$tagArea,l.$editor)})}).blur(function(t){l.blurCausedByClickInsideComponent?l.$editor.focus():(l.$originalInput.triggerHandler("blur"),l.onBlur.fire(),l.$tagComboBox.removeClass("focus"),l.entries=null,l.closeDropDown(),l.config.allowFreeText&&l.$editor.text().trim().length>0&&l.setSelectedEntry(l.config.freeTextEntryFactory(l.$editor.text()),!0,t),l.config.removePartialTagOnBlur&&null!=l.currentPartialTag&&l.cancelPartialTag(),l.$editor.text(""))}).keydown(function(t){if(!r.keyCodes.isModifierKey(t))if(t.which==r.keyCodes.tab||t.which==r.keyCodes.enter){var e=l.listBox.getHighlightedEntry();l.isDropDownOpen&&null!=e?(l.setSelectedEntry(e,!0,t),t.preventDefault()):l.config.allowFreeText&&l.$editor.text().trim().length>0?(l.setSelectedEntry(l.config.freeTextEntryFactory(l.$editor.text()),!0,t),t.preventDefault()):l.currentPartialTag&&(t.shiftKey?l.doIgnoringBlurEvents(function(){return l.$editor.insertAfter(l.currentPartialTag._trEntryElement)}):l.doIgnoringBlurEvents(function(){return l.$editor.insertBefore(l.currentPartialTag._trEntryElement)}),l.currentPartialTag._trEntryElement.remove(),l.currentPartialTag=null),l.closeDropDown(),t.which==r.keyCodes.enter&&t.preventDefault()}else if(t.which==r.keyCodes.left_arrow||t.which==r.keyCodes.right_arrow)t.which==r.keyCodes.left_arrow&&0===l.$editor.text().length&&0===window.getSelection().anchorOffset?l.$editor.prev()&&(l.doIgnoringBlurEvents(function(){return l.$editor.insertBefore(l.$editor.prev())}),l.focusEditor()):t.which==r.keyCodes.right_arrow&&0===l.$editor.text().length&&0===window.getSelection().anchorOffset&&l.$editor.next()&&(l.doIgnoringBlurEvents(function(){return l.$editor.insertAfter(l.$editor.next())}),l.focusEditor());else if(t.which==r.keyCodes.backspace||t.which==r.keyCodes.delete)if(""==l.$editor.text())if(null!=l.currentPartialTag)l.cancelPartialTag(),l.focusEditor();else{var i=l.selectedEntries[l.$editor.index()+(t.which==r.keyCodes.backspace?-1:0)];i&&(l.removeTag(i,t),l.closeDropDown())}else l.doNoAutoCompleteBecauseBackspaceWasPressed=!0,setTimeout(function(){return l.query(1)});else{if(t.which==r.keyCodes.up_arrow||t.which==r.keyCodes.down_arrow){l.openDropDown();var n=t.which==r.keyCodes.up_arrow?-1:1;return l.isDropDownOpen?(l.listBox.highlightNextEntry(n),l.autoCompleteIfPossible(l.config.autoCompleteDelay)):(setTimeout(function(){return l.query(n)}),l.config.showDropDownOnResultsOnly||l.openDropDown()),!1}t.which==r.keyCodes.escape?(l.closeDropDown(),l.$editor.text().length>0?l.$editor.text(""):null!=l.currentPartialTag&&(l.cancelPartialTag(),l.focusEditor())):(l.config.showDropDownOnResultsOnly||l.openDropDown(),setTimeout(function(){return l.query(1)}))}}).keyup(function(t){function e(t,e){return t.split(new RegExp("["+r.escapeSpecialRegexCharacter(e.join())+"]"))}if(l.$editor.find("*").length>0&&l.$editor.text(l.$editor.text()),l.config.allowFreeText){var i=l.getNonSelectedEditorValue();if(i.length>0)for(var n=e(i,l.config.freeTextSeparators),o=0;o<n.length-1;o++){var s=n[o].trim();s.length>0&&l.setSelectedEntry(l.config.freeTextEntryFactory(s),!0,t),l.$editor.text(n[n.length-1]),r.selectElementContents(l.$editor[0],l.$editor.text().length,l.$editor.text().length),l.entries=null,l.closeDropDown()}}}).mousedown(function(){l.config.showDropDownOnResultsOnly||l.openDropDown(),l.query()}),this.$originalInput.attr("placeholder")&&this.$editor.attr("placeholder",this.$originalInput.attr("placeholder")),this.$originalInput.attr("tabindex")&&this.$editor.attr("tabindex",this.$originalInput.attr("tabindex")),this.$originalInput.attr("autofocus")&&this.$editor.focus(),this.$tagComboBox.add(this.$dropDown).mousedown(function(){l.$editor.is(":focus")&&(l.blurCausedByClickInsideComponent=!0)}).mouseup(function(){l.blurCausedByClickInsideComponent&&(l.focusEditor(),setTimeout(function(){return l.blurCausedByClickInsideComponent=!1}))}).mouseout(function(){l.blurCausedByClickInsideComponent&&(l.focusEditor(),setTimeout(function(){return l.blurCausedByClickInsideComponent=!1}))});var a=i.extend({},this.config);a.entries=[],this.listBox=new o.TrivialListBox(this.$dropDown,a),this.listBox.onSelectedEntryChanged.addListener(function(t,e,i){t&&(l.setSelectedEntry(t,!0,i),l.listBox.setSelectedEntry(null),l.closeDropDown())}),this.$tagArea.mousedown(function(t){if(null==l.currentPartialTag){var e=l.findNearestTag(t);if(e){var i=e[0].getBoundingClientRect(),n=t.clientX>(i.left+i.right)/2;n?l.doIgnoringBlurEvents(function(){return l.$editor.insertAfter(e)}):l.doIgnoringBlurEvents(function(){return l.$editor.insertBefore(e)})}}l.$editor.focus()}).click(function(t){l.config.showDropDownOnResultsOnly||l.openDropDown(),l.query()}),this.setSelectedEntries(this.config.selectedEntries),this.$tagComboBox.data("trivialTagComboBox",this)}return t.prototype.cancelPartialTag=function(){var t=this;this.doIgnoringBlurEvents(function(){return t.$editor.insertBefore(t.currentPartialTag._trEntryElement)}),this.currentPartialTag._trEntryElement.remove(),this.currentPartialTag=null},t.prototype.findNearestTag=function(t){for(var e=null,i=1e6,n=0;n<this.selectedEntries.length;n++){var o=this.selectedEntries[n],r=o._trEntryElement,s=r[0].getBoundingClientRect(),l=t.clientY>=s.top&&t.clientY<s.bottom,a=t.clientX>=s.left&&t.clientX<s.right,u=a?0:Math.min(Math.abs(t.clientX-s.left),Math.abs(t.clientX-s.right));if(l&&u<i&&(e=r,i=u,0===u))break}return e},t.prototype.updateListBoxEntries=function(){this.blurCausedByClickInsideComponent=!1,this.listBox.updateEntries(this.entries),this.listBoxDirty=!1},t.prototype.updateEntries=function(t,e){this.entries=t,this.$spinners.remove(),this.$spinners=i(),this.isDropDownOpen?this.updateListBoxEntries():this.listBoxDirty=!0;var n=this.getNonSelectedEditorValue();this.listBox.highlightTextMatches(t.length<=this.config.textHighlightingEntryLimit?n:null),e?this.listBox.highlightNextEntry(e):this.listBox.setHighlightedEntry(null),this.autoCompleteIfPossible(this.config.autoCompleteDelay),this.isDropDownOpen&&this.openDropDown()},t.prototype.removeTag=function(t,e){var i=this.selectedEntries.indexOf(t);i>-1&&this.selectedEntries.splice(i,1),t._trEntryElement.remove(),this.$originalInput.val(this.config.valueFunction(this.getSelectedEntries())),this.fireChangeEvents(this.getSelectedEntries(),e)},t.prototype.query=function(t){var e=this,n=this.getNonSelectedEditorValue(),o=this.$editor.text().replace(String.fromCharCode(160)," ");if(this.lastQueryString!==n||this.lastCompleteInputQueryString!==o){if(0===this.$spinners.length){var r=i(this.config.spinnerTemplate).appendTo(this.$dropDown);this.$spinners=this.$spinners.add(r)}this.config.queryFunction(n,function(i){e.updateEntries(i,t),e.config.showDropDownOnResultsOnly&&i&&i.length>0&&e.$editor.is(":focus")&&e.openDropDown()}),this.lastQueryString=n,this.lastCompleteInputQueryString=o}},t.prototype.fireChangeEvents=function(t,e){this.$originalInput.trigger("change"),this.onSelectedEntryChanged.fire(t,e)},t.prototype.setSelectedEntry=function(t,e,n){var o=this;if(void 0===e&&(e=!1),null!=t&&this.config.selectionAcceptor(t)){var r=!!this.currentPartialTag,s=r?this.currentPartialTag._trEntryElement.index():this.$editor.index();r&&(this.doIgnoringBlurEvents(function(){return o.$editor.appendTo(o.$tagArea)}),this.currentPartialTag._trEntryElement.remove(),t=this.config.entryMerger(this.currentPartialTag,t));var l=i.extend({},t);this.config.tagCompleteDecider(t)?(this.selectedEntries.splice(s,0,l),this.$originalInput.val(this.config.valueFunction(this.getSelectedEntries())),this.currentPartialTag=null):this.currentPartialTag=l;var a=i(this.config.selectedEntryRenderingFunction(l)),u=i('<div class="tr-tagbox-tag"></div>').append(a);this.doIgnoringBlurEvents(function(){return o.insertAtIndex(u,s)}),l._trEntryElement=u,a.find(".tr-remove-button").click(function(t){return o.removeTag(l),!1}),this.config.tagCompleteDecider(t)?this.doIgnoringBlurEvents(function(){return o.insertAtIndex(o.$editor,s+1)}):this.doIgnoringBlurEvents(function(){return o.$editor.appendTo(a.find(".tr-editor"))}),this.$editor.text(""),this.focusEditor(),this.config.tagCompleteDecider(t)&&e&&this.fireChangeEvents(this.getSelectedEntries(),n)}},t.prototype.focusEditor=function(){r.selectElementContents(this.$editor[0],0,0),this.$editor.focus()},t.prototype.repositionDropDown=function(){var t=this;this.$dropDown.position({my:"left top",at:"left bottom",of:this.$tagComboBox,collision:"flip",using:function(e,i){"top"===i.vertical?(t.$tagComboBox.removeClass("dropdown-flipped"),t.$dropDown.removeClass("flipped")):(t.$tagComboBox.addClass("dropdown-flipped"),t.$dropDown.addClass("flipped")),t.$dropDown.css({left:e.left+"px",top:e.top+"px"})}}).width(this.$tagComboBox.width())},t.prototype.openDropDown=function(){var t=this;this.isDropDownNeeded()&&(this.listBoxDirty&&this.updateListBoxEntries(),this.$tagComboBox.addClass("open"),this.$dropDown.show(),this.repositionDropDown(),this.isDropDownOpen=!0),null==this.repositionDropDownScheduler&&(this.repositionDropDownScheduler=window.setInterval(function(){return t.repositionDropDown()},300))},t.prototype.closeDropDown=function(){this.$tagComboBox.removeClass("open"),this.$dropDown.hide(),this.isDropDownOpen=!1,null!=this.repositionDropDownScheduler&&(clearInterval(this.repositionDropDownScheduler),this.repositionDropDownScheduler=null)},t.prototype.getNonSelectedEditorValue=function(){var t=this.$editor.text().replace(String.fromCharCode(160)," "),e=window.getSelection();return e.anchorOffset!=e.focusOffset?t.substring(0,Math.min(window.getSelection().baseOffset,window.getSelection().focusOffset)):t},t.prototype.autoCompleteIfPossible=function(t){var e=this;if(this.config.autoComplete){clearTimeout(this.autoCompleteTimeoutId);var i=this.listBox.getHighlightedEntry();i&&!this.doNoAutoCompleteBecauseBackspaceWasPressed&&(this.autoCompleteTimeoutId=window.setTimeout(function(){var t=e.getNonSelectedEditorValue(),n=e.config.autoCompleteFunction(t,i)||t;e.$editor.text(t+n.replace(" ",String.fromCharCode(160)).substr(t.length)),e.repositionDropDown(),e.$editor.is(":focus")&&r.selectElementContents(e.$editor[0],t.length,n.length)},t||0)),this.doNoAutoCompleteBecauseBackspaceWasPressed=!1}},t.prototype.isDropDownNeeded=function(){return"editable"==this.editingMode&&(this.config.entries&&this.config.entries.length>0||!this.usingDefaultQueryFunction||this.config.showTrigger)},t.prototype.insertAtIndex=function(t,e){var i=this.$tagArea.children().length;e<i?this.$tagArea.children().eq(e).before(t):this.$tagArea.append(t)},t.prototype.doIgnoringBlurEvents=function(t){var e=this.blurCausedByClickInsideComponent;this.blurCausedByClickInsideComponent=!0;try{return t.call(this)}finally{this.blurCausedByClickInsideComponent=e}},t.prototype.setEditingMode=function(t){this.editingMode=t,this.$tagComboBox.removeClass("editable readonly disabled").addClass(this.editingMode),this.isDropDownNeeded()&&this.$dropDown.appendTo(this.$dropDownTargetElement)},t.prototype.setSelectedEntries=function(t){var e=this;if(this.selectedEntries.slice().forEach(function(t){return e.removeTag(t)}),t)for(var i=0;i<t.length;i++)this.setSelectedEntry(t[i])},t.prototype.getSelectedEntries=function(){for(var t=[],e=0;e<this.selectedEntries.length;e++){var n=i.extend({},this.selectedEntries[e]);delete n._trEntryElement,t.push(n)}return t},t.prototype.getCurrentPartialTag=function(){return this.currentPartialTag},t.prototype.focus=function(){this.$editor.focus(),r.selectElementContents(this.$editor[0],0,this.$editor.text().length)},t.prototype.getEditor=function(){return this.$editor[0]},t.prototype.destroy=function(){this.$originalInput.removeClass("tr-original-input").insertBefore(this.$tagComboBox),this.$tagComboBox.remove(),this.$dropDown.remove()},t.prototype.getMainDomElement=function(){return this.$tagComboBox[0]},t}();e.TrivialTagComboBox=l});