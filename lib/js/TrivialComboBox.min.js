/*! Trivial Components | (c) 2015 Yann Massard and others | Apache License, Version 2.0 (https://raw.githubusercontent.com/trivial-components/trivial-components/master/LICENSE) */
!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd?define(["require","exports","jquery","mustache","./TrivialCore","./TrivialListBox","./TrivialEvent"],t):(window.TrivialComponents=window.TrivialComponents||{},t(function(t){return"jquery"===t?window.jQuery:"levenshtein"===t?window.Levenshtein:"moment"===t?window.moment:"mustache"===t?window.Mustache:window.TrivialComponents},window.TrivialComponents))}(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var o=t("jquery"),i=t("mustache"),n=t("./TrivialCore"),s=t("./TrivialListBox"),r=t("./TrivialEvent"),l=function(){function t(t,e){void 0===e&&(e={});var l=this;this.$spinners=o(),this.onSelectedEntryChanged=new r.TrivialEvent(this),this.onFocus=new r.TrivialEvent(this),this.onBlur=new r.TrivialEvent(this),this.isDropDownOpen=!1,this.isEditorVisible=!1,this.lastQueryString=null,this.lastCompleteInputQueryString=null,this.selectedEntry=null,this.lastCommittedValue=null,this.blurCausedByClickInsideComponent=!1,this.autoCompleteTimeoutId=-1,this.doNoAutoCompleteBecauseBackspaceWasPressed=!1,this.listBoxDirty=!0,this.usingDefaultQueryFunction=!1,this.config=o.extend({valueFunction:function(t){return t?""+t.id:null},entryRenderingFunction:function(t){return i.render(n.DEFAULT_TEMPLATES.image2LinesTemplate,t)},selectedEntryRenderingFunction:function(t){return l.config.entryRenderingFunction(t)},selectedEntry:void 0,spinnerTemplate:n.DEFAULT_TEMPLATES.defaultSpinnerTemplate,noEntriesTemplate:n.DEFAULT_TEMPLATES.defaultNoEntriesTemplate,textHighlightingEntryLimit:100,entries:null,queryFunction:null,autoComplete:!0,autoCompleteDelay:0,entryToEditorTextFunction:function(t){return t.displayValue},autoCompleteFunction:function(t,e){if(t){for(var o in e)if(e.hasOwnProperty(o)){var i=e[o];if(i&&0===i.toString().toLowerCase().indexOf(t.toLowerCase()))return i.toString()}return null}return e?l.config.entryToEditorTextFunction(e):null},allowFreeText:!1,freeTextEntryFactory:function(t){return{displayValue:t,_isFreeTextEntry:!0}},showClearButton:!1,showTrigger:!0,matchingOptions:{matchingMode:"contains",ignoreCase:!0,maxLevenshteinDistance:2},editingMode:"editable",showDropDownOnResultsOnly:!1},e),this.config.queryFunction||(this.config.queryFunction=n.defaultListQueryFunctionFactory(this.config.entries||[],this.config.matchingOptions),this.usingDefaultQueryFunction=!0),this.entries=this.config.entries,this.$originalInput=o(t),this.$comboBox=o('<div class="tr-combobox tr-input-wrapper"/>').insertAfter(this.$originalInput),this.$selectedEntryWrapper=o('<div class="tr-combobox-selected-entry-wrapper"/>').appendTo(this.$comboBox),this.config.showClearButton&&(this.$clearButton=o('<div class="tr-remove-button">').appendTo(this.$comboBox),this.$clearButton.mousedown(function(t){l.$editor.val(""),l.setSelectedEntry(null,!0,!0,t)})),this.config.showTrigger&&(this.$trigger=o('<div class="tr-trigger"><span class="tr-trigger-icon"/></div>').appendTo(this.$comboBox),this.$trigger.mousedown(function(){l.isDropDownOpen?(l.showEditor(),l.closeDropDown()):setTimeout(function(){l.showEditor(),l.$editor.select(),l.openDropDown(),l.query()})})),this.$dropDown=o('<div class="tr-dropdown"></div>').scroll(function(){return!1}),this.$dropDownTargetElement=o("body"),this.setEditingMode(this.config.editingMode),this.$originalInput.addClass("tr-original-input"),this.$editor=o('<input type="text" autocomplete="off"/>'),this.$editor.prependTo(this.$comboBox).addClass("tr-combobox-editor tr-editor").focus(function(){l.blurCausedByClickInsideComponent||(l.$originalInput.triggerHandler("focus"),l.onFocus.fire(),l.$comboBox.addClass("focus"),l.showEditor())}).blur(function(t){l.blurCausedByClickInsideComponent?l.$editor.focus():(l.$originalInput.triggerHandler("blur"),l.onBlur.fire(),l.$comboBox.removeClass("focus"),l.editorContainsFreeText()?n.objectEquals(l.getSelectedEntry(),l.lastCommittedValue)||l.setSelectedEntry(l.getSelectedEntry(),!0,!0,t):(l.$editor.val(""),l.setSelectedEntry(l.lastCommittedValue,!1,!0,t)),l.hideEditor(),l.closeDropDown())}).keydown(function(t){if(!n.keyCodes.isModifierKey(t)){if(t.which==n.keyCodes.tab){var e=l.listBox.getHighlightedEntry();return void(l.isDropDownOpen&&e?l.setSelectedEntry(e,!0,!0,t):l.$editor.val()?l.config.allowFreeText&&l.setSelectedEntry(l.getSelectedEntry(),!0,!0,t):l.setSelectedEntry(null,!0,!0))}if(t.which==n.keyCodes.left_arrow||t.which==n.keyCodes.right_arrow)return void l.showEditor();if(setTimeout(function(){var e=!n.keyCodes.isModifierKey(t)&&[n.keyCodes.enter,n.keyCodes.escape,n.keyCodes.tab].indexOf(t.which)===-1,o=l.isEntrySelected()&&l.$editor.val()!==l.config.entryToEditorTextFunction(l.selectedEntry);e&&(o||l.config.valueFunction(l.listBox.getHighlightedEntry()))!==l.config.valueFunction(l.getSelectedEntry())&&l.setSelectedEntry(null,!1,!1,t)}),t.which!=n.keyCodes.backspace&&t.which!=n.keyCodes.delete||(l.doNoAutoCompleteBecauseBackspaceWasPressed=!0),t.which==n.keyCodes.up_arrow||t.which==n.keyCodes.down_arrow){l.isEditorVisible||(l.$editor.select(),l.showEditor());var o=t.which==n.keyCodes.up_arrow?-1:1;return l.isDropDownOpen?(l.listBox.highlightNextEntry(o),l.autoCompleteIfPossible()):(l.query(o),l.config.showDropDownOnResultsOnly||l.openDropDown()),!1}if(t.which==n.keyCodes.enter){if(l.isEditorVisible||l.editorContainsFreeText()){t.preventDefault();var e=l.listBox.getHighlightedEntry();l.isDropDownOpen&&e?l.setSelectedEntry(e,!0,!0,t):l.$editor.val()?l.config.allowFreeText&&l.setSelectedEntry(l.getSelectedEntry(),!0,!0,t):l.setSelectedEntry(null,!0,!0,t),l.closeDropDown(),l.hideEditor()}}else t.which==n.keyCodes.escape?(t.preventDefault(),l.editorContainsFreeText()&&l.isDropDownOpen||(l.hideEditor(),l.$editor.val(""),l.entries=null,l.setSelectedEntry(l.lastCommittedValue,!1,!0,t)),l.closeDropDown()):(l.isEditorVisible||(l.showEditor(),l.$editor.select()),l.config.showDropDownOnResultsOnly||l.openDropDown(),setTimeout(function(){l.$editor.val()?l.query(1):(l.query(0),l.listBox.setHighlightedEntry(null))}))}}).mousedown(function(){l.config.showDropDownOnResultsOnly||l.openDropDown(),l.query()}),this.$originalInput.attr("tabindex")&&this.$editor.attr("tabindex",this.$originalInput.attr("tabindex")),this.$originalInput.attr("autofocus")&&this.$editor.focus(),this.$comboBox.add(this.$dropDown).mousedown(function(){l.$editor.is(":focus")&&(l.blurCausedByClickInsideComponent=!0)}).mouseup(function(){l.blurCausedByClickInsideComponent&&(l.$editor.focus(),l.blurCausedByClickInsideComponent=!1)}).mouseout(function(){l.blurCausedByClickInsideComponent&&(l.$editor.focus(),l.blurCausedByClickInsideComponent=!1)});var d=o.extend({},this.config);d.entries=[],this.listBox=new s.TrivialListBox(this.$dropDown,d),this.listBox.onSelectedEntryChanged.addListener(function(t,e,o){t&&(l.setSelectedEntry(t,!0,!n.objectEquals(t,l.lastCommittedValue),o),l.listBox.setSelectedEntry(null),l.closeDropDown()),l.hideEditor()}),this.setSelectedEntry(this.config.selectedEntry,!0,!1),this.$selectedEntryWrapper.click(function(){l.showEditor(),l.$editor.select(),l.config.showDropDownOnResultsOnly||l.openDropDown(),l.query()})}return t.prototype.query=function(t){var e=this,i=this.getNonSelectedEditorValue(),n=this.$editor.val();if(this.lastQueryString!==i||this.lastCompleteInputQueryString!==n){if(0===this.$spinners.length){var s=o(this.config.spinnerTemplate).appendTo(this.$dropDown);this.$spinners=this.$spinners.add(s)}this.config.queryFunction(i,function(o){e.updateEntries(o,t),e.config.showDropDownOnResultsOnly&&o&&o.length>0&&e.$editor.is(":focus")&&e.openDropDown()}),this.lastQueryString=i,this.lastCompleteInputQueryString=n}else this.openDropDown()},t.prototype.fireChangeEvents=function(t,e){this.$originalInput.trigger("change"),this.onSelectedEntryChanged.fire(t,e)},t.prototype.setSelectedEntry=function(t,e,i,n){void 0===e&&(e=!0),void 0===i&&(i=!1),this.$originalInput.val(this.config.valueFunction(t)),this.selectedEntry=t;var s=o(this.config.selectedEntryRenderingFunction(t)).addClass("tr-combobox-entry");this.$selectedEntryWrapper.empty().append(s),null!=t&&this.$editor.val(this.config.entryToEditorTextFunction(t)),e&&(this.lastCommittedValue=t,i&&this.fireChangeEvents(t,n)),this.$clearButton&&this.$clearButton.toggle(null!=t),this.isEditorVisible&&this.showEditor(),this.isDropDownOpen&&this.repositionDropDown()},t.prototype.isEntrySelected=function(){return null!=this.selectedEntry},t.prototype.showEditor=function(){var t=this.$selectedEntryWrapper.find(".tr-editor-area");0===t.length&&(t=this.$selectedEntryWrapper),this.$editor.css({width:Math.min(t[0].offsetWidth,this.$trigger?this.$trigger[0].offsetLeft-t[0].offsetLeft:99999999)+"px",height:t[0].offsetHeight+"px"}).position({my:"left top",at:"left top",of:t}),this.isEditorVisible=!0},t.prototype.editorContainsFreeText=function(){return this.config.allowFreeText&&this.$editor.val().length>0&&!this.isEntrySelected()},t.prototype.hideEditor=function(){this.$editor.width(0).height(0),this.isEditorVisible=!1},t.prototype.repositionDropDown=function(){var t=this;this.$dropDown.show().position({my:"left top",at:"left bottom",of:this.$comboBox,collision:"flip",using:function(e,o){"top"===o.vertical?(t.$comboBox.removeClass("dropdown-flipped"),t.$dropDown.removeClass("flipped")):(t.$comboBox.addClass("dropdown-flipped"),t.$dropDown.addClass("flipped")),t.$dropDown.css({left:e.left+"px",top:e.top+"px"})}}).width(this.$comboBox.width())},t.prototype.openDropDown=function(){this.isDropDownNeeded()&&(this.listBoxDirty&&this.updateListBoxEntries(),this.$comboBox.addClass("open"),this.repositionDropDown(),this.isDropDownOpen=!0)},t.prototype.closeDropDown=function(){this.$comboBox.removeClass("open"),this.$dropDown.hide(),this.isDropDownOpen=!1},t.prototype.getNonSelectedEditorValue=function(){return this.$editor.val().substring(0,this.$editor[0].selectionStart)},t.prototype.autoCompleteIfPossible=function(t){var e=this;if(this.config.autoComplete){clearTimeout(this.autoCompleteTimeoutId);var o=this.listBox.getHighlightedEntry();o&&!this.doNoAutoCompleteBecauseBackspaceWasPressed&&(this.autoCompleteTimeoutId=n.setTimeoutOrDoImmediately(function(){var t=e.getNonSelectedEditorValue(),i=e.config.autoCompleteFunction(t,o)||t;e.$editor.val(t+i.substr(t.length)),e.$editor.is(":focus")&&e.$editor[0].setSelectionRange(t.length,i.length)},t)),this.doNoAutoCompleteBecauseBackspaceWasPressed=!1}},t.prototype.updateListBoxEntries=function(){this.blurCausedByClickInsideComponent=!1,this.listBox.updateEntries(this.entries),this.listBoxDirty=!1},t.prototype.updateEntries=function(t,e){this.entries=t,this.$spinners.remove(),this.$spinners=o(),this.isDropDownOpen?this.updateListBoxEntries():this.listBoxDirty=!0;var i=this.getNonSelectedEditorValue();this.listBox.highlightTextMatches(t.length<=this.config.textHighlightingEntryLimit?i:null),null==e?this.selectedEntry?this.listBox.setHighlightedEntry(null):this.listBox.highlightNextEntry(1):0===e?this.listBox.setHighlightedEntry(null):this.listBox.highlightNextEntry(e),this.autoCompleteIfPossible(this.config.autoCompleteDelay),this.isDropDownOpen&&this.openDropDown()},t.prototype.isDropDownNeeded=function(){return"editable"==this.editingMode&&(this.config.entries&&this.config.entries.length>0||!this.usingDefaultQueryFunction||this.config.showTrigger)},t.prototype.setEditingMode=function(t){this.editingMode=t,this.$comboBox.removeClass("editable readonly disabled").addClass(this.editingMode),this.isDropDownNeeded()&&this.$dropDown.appendTo(this.$dropDownTargetElement)},t.prototype.getSelectedEntry=function(){if(null!=this.selectedEntry||this.config.allowFreeText&&this.$editor.val()){if(null==this.selectedEntry&&this.config.allowFreeText)return this.config.freeTextEntryFactory(this.$editor.val());var t=o.extend({},this.selectedEntry);return delete t._trEntryElement,t}return null},t.prototype.focus=function(){this.showEditor(),this.$editor.select()},t.prototype.getEditor=function(){return this.$editor[0]},t.prototype.getDropDown=function(){return this.$dropDown},t.prototype.destroy=function(){this.$originalInput.removeClass("tr-original-input").insertBefore(this.$comboBox),this.$comboBox.remove(),this.$dropDown.remove()},t.prototype.getMainDomElement=function(){return this.$comboBox[0]},t}();e.TrivialComboBox=l});