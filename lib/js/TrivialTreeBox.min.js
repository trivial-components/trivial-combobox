/*! Trivial Components | (c) 2015 Yann Massard and others | Apache License, Version 2.0 (https://raw.githubusercontent.com/trivial-components/trivial-components/master/LICENSE) */
!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd?define(["require","exports","jquery","mustache","./TrivialCore","./TrivialEvent"],e):(window.TrivialComponents=window.TrivialComponents||{},e(function(e){return"jquery"===e?window.jQuery:"levenshtein"===e?window.Levenshtein:"moment"===e?window.moment:"mustache"===e?window.Mustache:window.TrivialComponents},window.TrivialComponents))}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=e("jquery"),r=e("mustache"),i=e("./TrivialCore"),o=e("./TrivialEvent"),s=function(){function e(e,t){void 0===t&&(t={}),this.onSelectedEntryChanged=new o.TrivialEvent(this),this.onNodeExpansionStateChanged=new o.TrivialEvent(this),this.config=n.extend({valueFunction:function(e){return e?""+e.id:null},childrenProperty:"children",lazyChildrenFlagProperty:"hasLazyChildren",lazyChildrenQueryFunction:function(e,t){t(e.children||[])},expandedProperty:"expanded",entryRenderingFunction:function(e,t){var n=[i.DEFAULT_TEMPLATES.icon2LinesTemplate,i.DEFAULT_TEMPLATES.iconSingleLineTemplate],o=e.template||n[Math.min(t,n.length-1)];return r.render(o,e)},spinnerTemplate:i.DEFAULT_TEMPLATES.defaultSpinnerTemplate,noEntriesTemplate:i.DEFAULT_TEMPLATES.defaultNoEntriesTemplate,entries:null,selectedEntryId:null,matchingOptions:{matchingMode:"contains",ignoreCase:!0,maxLevenshteinDistance:2},animationDuration:70,showExpanders:!0,expandOnSelection:!1,enforceSingleExpandedPath:!1},t),this.entries=this.config.entries,this.$componentWrapper=n('<div class="tr-treebox"/>').appendTo(e),this.$componentWrapper.toggleClass("hide-expanders",!this.config.showExpanders),this.$tree=n('<div class="tr-tree-entryTree"></div>').appendTo(this.$componentWrapper),this.entries&&this.updateEntries(this.entries),this.setSelectedEntry(void 0!==this.config.selectedEntryId&&null!==this.config.selectedEntryId?this.findEntryById(this.config.selectedEntryId):null)}return e.prototype.isLeaf=function(e){return(null==e[this.config.childrenProperty]||0==e[this.config.childrenProperty].length)&&!e[this.config.lazyChildrenFlagProperty]},e.prototype.createEntryElement=function(e,t){var r=this,i=this.isLeaf(e),o=n('<div class="tr-tree-entry-outer-wrapper '+(i?"":"has-children")+'" data-depth="'+t+'"></div>');e._trEntryElement=o;for(var s=n('<div class="tr-tree-entry-and-expander-wrapper"></div>').appendTo(o),h=0;h<t;h++)s.append('<div class="tr-indent-spacer"/>');var d=n('<div class="tr-tree-expander"></div>').appendTo(s),l=n(this.config.entryRenderingFunction(e,t));if(l.addClass("tr-tree-entry filterable-item").appendTo(s),this.config.valueFunction(e)===this.selectedEntryId&&s.addClass("tr-selected-entry"),s.mousedown(function(t){r.$componentWrapper.trigger("mousedown",t),r.setSelectedEntry(e)}).mouseup(function(e){r.$componentWrapper.trigger("mouseup",e)}).mouseenter(function(){r.setHighlightedEntry(e)}).mouseleave(function(e){n(e.toElement).is(".tr-tree-entry-outer-wrapper")||r.setHighlightedEntry(null)}),!i){var a=n('<div class="tr-tree-entry-children-wrapper"></div>').appendTo(o);if(d.mousedown(function(){return!1}).click(function(t){r.setNodeExpanded(e,!e[r.config.expandedProperty],!0)}),e[this.config.childrenProperty]){if(e[this.config.expandedProperty])for(var p=0;p<e[this.config.childrenProperty].length;p++)this.createEntryElement(e[this.config.childrenProperty][p],t+1).appendTo(a)}else e[this.config.lazyChildrenFlagProperty]&&a.hide().append(this.config.spinnerTemplate).fadeIn();this.setNodeExpanded(e,e[this.config.expandedProperty],!1)}return o},e.prototype.updateTreeEntryElements=function(){if(this.$tree.detach(),this.$tree=n('<div class="tr-tree-entryTree"></div>'),this.entries.length>0)for(var e=0;e<this.entries.length;e++)this.createEntryElement(this.entries[e],0).appendTo(this.$tree);else this.$tree.append(this.config.noEntriesTemplate);this.$tree.appendTo(this.$componentWrapper)},e.prototype.setNodeExpanded=function(e,t,r){var i=this,o=e[this.config.expandedProperty];if(t&&this.config.enforceSingleExpandedPath)for(var s=this.findEntries(function(e){return!!e[i.config.expandedProperty]}),h=this.findPathToFirstMatchingNode(function(t){return t===e}),d=0;d<s.length;d++){var l=s[d];h.indexOf(l)===-1&&this.setNodeExpanded(l,!1,!0)}e[this.config.expandedProperty]=!!t,e._trEntryElement.toggleClass("expanded",!!t);var a=function(e){return e[i.config.childrenProperty]&&e[i.config.childrenProperty].some(function(e){return!e._trEntryElement||!n.contains(document.documentElement,e._trEntryElement[0])})};t&&e[this.config.lazyChildrenFlagProperty]&&!e[this.config.childrenProperty]?this.config.lazyChildrenQueryFunction(e,function(t){i.setChildren(e,t)}):t&&a(e)&&this.renderChildren(e),t&&this.minimallyScrollTo(e._trEntryElement);var p=e._trEntryElement.find("> .tr-tree-entry-children-wrapper");t?r?p.slideDown(this.config.animationDuration):p.css("display","block"):r?p.slideUp(this.config.animationDuration):p.hide(),!!o!=!!t&&this.onNodeExpansionStateChanged.fire(e)},e.prototype.nodeDepth=function(e){return e?parseInt(e._trEntryElement.attr("data-depth")):0},e.prototype.setChildren=function(e,t){e[this.config.childrenProperty]=t,e[this.config.lazyChildrenFlagProperty]=!1,this.renderChildren(e)},e.prototype.renderChildren=function(e){var t=e._trEntryElement.find("> .tr-tree-entry-children-wrapper");t.empty();var n=e[this.config.childrenProperty];if(n&&n.length>0)for(var r=this.nodeDepth(e),i=0;i<n.length;i++){var o=n[i];this.createEntryElement(o,r+1).appendTo(t)}else e._trEntryElement.removeClass("has-children expanded")},e.prototype.updateEntries=function(e){this.highlightedEntry=null,this.entries=e,this.updateTreeEntryElements();var t=this.findEntryById(this.selectedEntryId);t&&this.markSelectedEntry(t)},e.prototype.findEntries=function(e){for(var t=this,n=function(r,i){if(e.call(t,r)&&i.push(r),r[t.config.childrenProperty])for(var o=0;o<r[t.config.childrenProperty].length;o++){var s=r[t.config.childrenProperty][o];n(s,i)}},r=[],i=0;i<this.entries.length;i++){var o=this.entries[i];n(o,r)}return r},e.prototype.findPathToFirstMatchingNode=function(e){for(var t=this,n=function(r,i){if(e.call(t,r,i))return i.push(r),i;if(r[t.config.childrenProperty]){var o=i.slice();o.push(r);for(var s=0;s<r[t.config.childrenProperty].length;s++){var h=r[t.config.childrenProperty][s],d=n(h,o);if(d)return d}}},r=0;r<this.entries.length;r++){var i=this.entries[r],o=n(i,[]);if(o)return o}},e.prototype.findEntryById=function(e){var t=this;return this.findEntries(function(n){return t.config.valueFunction(n)===e})[0]},e.prototype.findParentNode=function(e){var t=this;return this.findEntries(function(n){return n[t.config.childrenProperty]&&n[t.config.childrenProperty].indexOf(e)!=-1})[0]},e.prototype.setSelectedEntry=function(e,t){this.selectedEntryId=e?this.config.valueFunction(e):null,this.markSelectedEntry(e),this.setHighlightedEntry(e),this.fireChangeEvents(e,t),e&&this.config.expandOnSelection&&this.setNodeExpanded(e,!0,!0)},e.prototype.setSelectedEntryById=function(e){this.setSelectedEntry(this.findEntryById(e),null)},e.prototype.minimallyScrollTo=function(e){i.minimallyScrollTo(this.$componentWrapper.parent(),e)},e.prototype.markSelectedEntry=function(e){if(this.$tree.find(".tr-selected-entry").removeClass("tr-selected-entry"),e&&e._trEntryElement){var t=e._trEntryElement.find(">.tr-tree-entry-and-expander-wrapper");t.addClass("tr-selected-entry")}},e.prototype.fireChangeEvents=function(e,t){this.$componentWrapper.trigger("change"),this.onSelectedEntryChanged.fire(e)},e.prototype.selectNextEntry=function(e,t){var n=this.getNextVisibleEntry(this.getSelectedEntry(),e);null!=n&&this.setSelectedEntry(n,t)},e.prototype.setHighlightedEntry=function(e){if(e!==this.highlightedEntry)if(this.highlightedEntry=e,this.$tree.find(".tr-highlighted-entry").removeClass("tr-highlighted-entry"),null!=e&&e._trEntryElement){var t=e._trEntryElement.find(">.tr-tree-entry-and-expander-wrapper");t.addClass("tr-highlighted-entry"),this.minimallyScrollTo(t)}else{var n=this.getSelectedEntry();n&&(this.highlightedEntry=n)}},e.prototype.getNextVisibleEntry=function(e,t,n){void 0===n&&(n=!1);var r,i=this.findEntries(function(t){return!!t._trEntryElement&&(n?t._trEntryElement.is(":visible")&&t._trEntryElement.has(">.tr-tree-entry-and-expander-wrapper .tr-highlighted-text").length>0:t._trEntryElement.is(":visible")||t===e)});if(null==i||0==i.length)return null;if(null==e&&t>0)r=-1+t;else if(null==e&&t<0)r=i.length+t;else{var o=i.indexOf(e);r=(o+i.length+t)%i.length}return i[r]},e.prototype.highlightTextMatches=function(e){this.$tree.detach();for(var t=0;t<this.entries.length;t++){var n=this.entries[t],r=n._trEntryElement.find(".tr-tree-entry");r.trivialHighlight(e,this.config.matchingOptions)}this.$tree.appendTo(this.$componentWrapper)},e.prototype.getSelectedEntry=function(){return void 0!==this.selectedEntryId&&null!==this.selectedEntryId?this.findEntryById(this.selectedEntryId):null},e.prototype.revealSelectedEntry=function(e){void 0===e&&(e=!1);var t=this.getSelectedEntry();if(t){for(var n=t;n=this.findParentNode(n);)this.setNodeExpanded(n,!0,e);this.minimallyScrollTo(t._trEntryElement)}},e.prototype.highlightNextEntry=function(e){var t=this.getNextVisibleEntry(this.highlightedEntry||this.getSelectedEntry(),e);null!=t&&this.setHighlightedEntry(t)},e.prototype.highlightNextMatchingEntry=function(e){var t=this.getNextVisibleEntry(this.highlightedEntry||this.getSelectedEntry(),e,!0);null!=t&&this.setHighlightedEntry(t)},e.prototype.selectNextMatchingEntry=function(e){var t=this.getNextVisibleEntry(this.highlightedEntry,e,!0);null!=t&&this.setSelectedEntry(t)},e.prototype.getHighlightedEntry=function(){return this.highlightedEntry},e.prototype.setHighlightedNodeExpanded=function(e){if(!this.highlightedEntry||this.isLeaf(this.highlightedEntry))return!1;var t=this.highlightedEntry[this.config.expandedProperty];return this.setNodeExpanded(this.highlightedEntry,e,!0),!t!=!e},e.prototype.updateChildren=function(e,t){var n=this.findEntryById(e);n&&this.setChildren(n,t)},e.prototype.updateNode=function(e){var t=this.findEntryById(this.config.valueFunction(e)),n=this.findParentNode(t);n?n[this.config.childrenProperty][n[this.config.childrenProperty].indexOf(t)]=e:this.entries[this.entries.indexOf(t)]=e,this.createEntryElement(e,this.nodeDepth(t)).insertAfter(t._trEntryElement),t._trEntryElement.remove()},e.prototype.removeNode=function(e){var t=this.findEntryById(e);if(t){var n=this.findParentNode(t);n?n[this.config.childrenProperty].splice(n[this.config.childrenProperty].indexOf(t),1):this.entries.splice(this.entries.indexOf(t),1),t._trEntryElement.remove()}},e.prototype.addNode=function(e,t){var n=this.findEntryById(e);this.isLeaf(n),n[this.config.childrenProperty]||(n[this.config.childrenProperty]=[]),n[this.config.childrenProperty].push(t);var r=this.createEntryElement(t,this.nodeDepth(n)+1);r.appendTo(n._trEntryElement.find(">.tr-tree-entry-children-wrapper")),n._trEntryElement.addClass("has-children")},e.prototype.destroy=function(){this.$componentWrapper.remove()},e.prototype.getMainDomElement=function(){return this.$componentWrapper[0]},e}();t.TrivialTreeBox=s});