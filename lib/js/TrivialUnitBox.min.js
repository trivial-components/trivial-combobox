/*! Trivial Components | (c) 2015 Yann Massard and others | Apache License, Version 2.0 (https://raw.githubusercontent.com/trivial-components/trivial-components/master/LICENSE) */
!function(t){if("object"==typeof module&&"object"==typeof module.exports){var e=t(require,exports);void 0!==e&&(module.exports=e)}else"function"==typeof define&&define.amd?define(["require","exports","jquery","mustache","./TrivialListBox","./TrivialCore","./TrivialEvent"],t):(window.TrivialComponents=window.TrivialComponents||{},t(function(t){return"jquery"===t?window.jQuery:"levenshtein"===t?window.Levenshtein:"moment"===t?window.moment:"mustache"===t?window.Mustache:window.TrivialComponents},window.TrivialComponents))}(function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=t("jquery"),n=t("mustache"),o=t("./TrivialListBox"),r=t("./TrivialCore"),s=t("./TrivialEvent"),a=function(){function t(t,e){void 0===e&&(e={});var a=this;this.onChange=new s.TrivialEvent(this),this.onSelectedEntryChanged=new s.TrivialEvent(this),this.onFocus=new s.TrivialEvent(this),this.onBlur=new s.TrivialEvent(this),this.isDropDownOpen=!1,this.blurCausedByClickInsideComponent=!1,this.$spinners=i(),this.config=i.extend({unitValueProperty:"code",unitIdProperty:"code",decimalPrecision:2,decimalSeparator:".",thousandsSeparator:",",unitDisplayPosition:"right",allowNullAmount:!0,entryRenderingFunction:function(t){return n.render(r.DEFAULT_TEMPLATES.currency2LineTemplate,t)},selectedEntryRenderingFunction:function(t){return n.render(r.DEFAULT_TEMPLATES.currencySingleLineShortTemplate,t)},amount:null,selectedEntry:void 0,spinnerTemplate:r.DEFAULT_TEMPLATES.defaultSpinnerTemplate,noEntriesTemplate:r.DEFAULT_TEMPLATES.defaultNoEntriesTemplate,entries:null,queryFunction:null,queryOnNonNumberCharacters:!0,openDropdownOnEditorClick:!1,showTrigger:!0,matchingOptions:{matchingMode:"prefix-word",ignoreCase:!0,maxLevenshteinDistance:2},editingMode:"editable"},e),this.config.queryFunction||(this.config.queryFunction=r.defaultListQueryFunctionFactory(this.config.entries||[],this.config.matchingOptions),this.usingDefaultQueryFunction=!0),this.entries=this.config.entries,this.numberRegex=new RegExp("\\d*\\"+this.config.decimalSeparator+"?\\d*","g"),this.$originalInput=i(t).addClass("tr-original-input"),this.$editor=i('<input type="text"/>'),this.$unitBox=i('<div class="tr-unitbox tr-input-wrapper"/>').insertAfter(this.$originalInput).addClass("left"===this.config.unitDisplayPosition?"unit-display-left":"unit-display-right"),this.$originalInput.appendTo(this.$unitBox),this.$selectedEntryAndTriggerWrapper=i('<div class="tr-unitbox-selected-entry-and-trigger-wrapper"/>').appendTo(this.$unitBox),this.$selectedEntryWrapper=i('<div class="tr-unitbox-selected-entry-wrapper"/>').appendTo(this.$selectedEntryAndTriggerWrapper),this.config.showTrigger&&i('<div class="tr-trigger"><span class="tr-trigger-icon"/></div>').appendTo(this.$selectedEntryAndTriggerWrapper),this.$selectedEntryAndTriggerWrapper.mousedown(function(){a.isDropDownOpen?a.closeDropDown():"editable"===a.editingMode&&setTimeout(function(){a.openDropDown(),a.query()})}),this.$dropDown=i('<div class="tr-dropdown"></div>').scroll(function(){return!1}),this.$dropDownTargetElement=i("body"),this.setEditingMode(this.config.editingMode),this.$editor.prependTo(this.$unitBox).addClass("tr-unitbox-editor tr-editor").focus(function(){return"editable"!==a.editingMode?(a.$editor.blur(),!1):void(a.blurCausedByClickInsideComponent||(a.onFocus.fire(),a.$unitBox.addClass("focus"),a.cleanupEditorValue(),a.$editor.select()))}).blur(function(){a.blurCausedByClickInsideComponent?a.$editor.focus():(a.onBlur.fire(),a.$unitBox.removeClass("focus"),a.formatEditorValue(),a.closeDropDown())}).keydown(function(t){if(!r.keyCodes.isModifierKey(t)){if(t.which==r.keyCodes.tab){var e=a.listBox.getHighlightedEntry();a.isDropDownOpen&&e&&a.setSelectedEntry(e,!0,t)}else if(t.which==r.keyCodes.left_arrow||t.which==r.keyCodes.right_arrow)return;if(t.which==r.keyCodes.up_arrow||t.which==r.keyCodes.down_arrow){var i=t.which==r.keyCodes.up_arrow?-1:1;return a.isDropDownOpen?a.listBox.highlightNextEntry(i):(a.openDropDown(),a.query(i)),!1}if(a.isDropDownOpen&&t.which==r.keyCodes.enter)t.preventDefault(),a.setSelectedEntry(a.listBox.getHighlightedEntry(),!0,t),a.closeDropDown();else if(t.which==r.keyCodes.escape)a.closeDropDown(),a.cleanupEditorValue();else if(!t.shiftKey&&r.keyCodes.numberKeys.indexOf(t.which)!=-1){var n=a.getEditorValueNumberPart(),o=n.indexOf(a.config.decimalSeparator),s=o!=-1&&n.length-(o+1)>=a.config.decimalPrecision,l=a.$editor.val(),d=l.indexOf(a.config.decimalSeparator),u=a.$editor[0].selectionStart,c=a.$editor[0].selectionEnd,p=d!==-1&&c>d&&u===c;if(s&&p){if(!/^\d$/.test(l[c]))return!1;a.$editor.val(l.substring(0,c)+l.substring(c+1)),a.$editor[0].setSelectionRange(c,c)}}}}).keyup(function(t){if(r.keyCodes.specialKeys.indexOf(t.which)==-1||t.which==r.keyCodes.backspace||t.which==r.keyCodes.delete){var e=new RegExp("(?:\\"+a.config.decimalSeparator+".*)\\"+a.config.decimalSeparator,"g").test(a.$editor.val());e&&(a.cleanupEditorValue(),a.$editor[0].setSelectionRange(a.$editor.val().length-a.config.decimalPrecision,a.$editor.val().length-a.config.decimalPrecision)),a.config.queryOnNonNumberCharacters?a.getQueryString().length>0?(a.openDropDown(),a.query(1)):a.closeDropDown():a.ensureDecimalInput()}}).mousedown(function(){a.config.openDropdownOnEditorClick&&(a.openDropDown(),null==a.entries&&a.query())}).change(function(t){a.updateOriginalInputValue(),a.fireChangeEvents(t)}),this.$unitBox.add(this.$dropDown).mousedown(function(){a.$editor.is(":focus")&&(a.blurCausedByClickInsideComponent=!0)}).mouseup(function(){a.blurCausedByClickInsideComponent&&(a.$editor.focus(),a.blurCausedByClickInsideComponent=!1)}).mouseout(function(){a.blurCausedByClickInsideComponent&&(a.$editor.focus(),a.blurCausedByClickInsideComponent=!1)}),this.listBox=new o.TrivialListBox(this.$dropDown,this.config),this.listBox.onSelectedEntryChanged.addListener(function(t,e,i){t&&(a.setSelectedEntry(t,!0,i),a.listBox.setSelectedEntry(null),a.closeDropDown())}),this.$editor.val(this.config.amount||this.$originalInput.val()),this.formatEditorValue(),this.setSelectedEntry(this.config.selectedEntry||null,!1,null)}return t.prototype.ensureDecimalInput=function(){var t=this.$editor[0].selectionEnd,e=this.$editor.val(),i=e.replace(new RegExp("[^-0-9"+this.config.decimalSeparator+this.config.thousandsSeparator+"]","g"),"");i=i.replace(/(\d*\.\d*)\./g,"$1"),i=i.replace(/(.)-*/g,"$1");var n=i.indexOf(this.config.decimalSeparator);if(n!=-1&&i.length-n-1>this.config.decimalPrecision&&(i=i.substring(0,n+1+this.config.decimalPrecision)),e!==i){this.$editor.val(i);var o=Math.min(this.$editor.val().length,t);try{this.$editor[0].setSelectionRange(o,o)}catch(t){}}},t.prototype.getQueryString=function(){return this.$editor.val().replace(this.numberRegex,"")},t.prototype.getEditorValueNumberPart=function(t){var e,i,n=this.$editor.val().match(this.numberRegex).join(""),o=n.indexOf(this.config.decimalSeparator);return o!==-1?(e=n.substring(0,o),i=n.substring(o+1,n.length).replace(/\D/g,"")):(e=n,i=""),0==e.length&&0==i.length?"":(t&&(i=(i+new Array(this.config.decimalPrecision+1).join("0")).substr(0,this.config.decimalPrecision)),e+this.config.decimalSeparator+i)},t.prototype.query=function(t){var e=this,n=i(this.config.spinnerTemplate).appendTo(this.$dropDown);this.$spinners=this.$spinners.add(n),setTimeout(function(){e.config.queryFunction(e.getQueryString(),function(i){e.updateEntries(i);var n=e.getQueryString();n.length>0&&e.listBox.highlightTextMatches(n),e.listBox.highlightNextEntry(t),e.isDropDownOpen&&e.openDropDown()})})},t.prototype.fireSelectedEntryChangedEvent=function(){this.onSelectedEntryChanged.fire(this.selectedEntry)},t.prototype.fireChangeEvents=function(t){this.$originalInput.trigger("change"),this.onChange.fire({unit:null!=this.selectedEntry?this.selectedEntry[this.config.unitValueProperty]:null,unitEntry:this.selectedEntry,amount:this.getAmount(),amountAsFloatingPointNumber:parseFloat(this.formatAmount(this.getAmount(),this.config.decimalPrecision,this.config.decimalSeparator,this.config.thousandsSeparator))},t)},t.prototype.setSelectedEntry=function(t,e,n){this.selectedEntry=t;var o=i(this.config.selectedEntryRenderingFunction(t)).addClass("tr-combobox-entry");this.$selectedEntryWrapper.empty().append(o),this.cleanupEditorValue(),this.updateOriginalInputValue(),this.$editor.is(":focus")||this.formatEditorValue(),e&&(this.fireSelectedEntryChangedEvent(),this.fireChangeEvents(n))},t.prototype.formatEditorValue=function(){this.$editor.val(this.formatAmount(this.getAmount(),this.config.decimalPrecision,this.config.decimalSeparator,this.config.thousandsSeparator))},t.prototype.cleanupEditorValue=function(){this.$editor.val()&&this.$editor.val(this.getEditorValueNumberPart(!0))},t.prototype.formatAmount=function(t,e,i,n){if(null==t||isNaN(t))return"";var o=""+t;if(o.length<=e)return 0+i+new Array(e-o.length+1).join("0")+o;var r=o.substring(0,o.length-e),s=r.replace(/\B(?=(\d{3})+(?!\d))/g,n),a=o.substr(o.length-e,e);return s+i+a},t.prototype.repositionDropDown=function(){var t=this;this.$dropDown.show().position({my:"left top",at:"left bottom",of:this.$unitBox,collision:"flip",using:function(e,i){"top"===i.vertical?(t.$unitBox.removeClass("dropdown-flipped"),t.$dropDown.removeClass("flipped")):(t.$unitBox.addClass("dropdown-flipped"),t.$dropDown.addClass("flipped")),t.$dropDown.css({left:e.left+"px",top:e.top+"px"})}}).width(this.$unitBox.width())},t.prototype.openDropDown=function(){this.$unitBox.addClass("open"),this.repositionDropDown(),this.isDropDownOpen=!0},t.prototype.closeDropDown=function(){this.$unitBox.removeClass("open"),this.$dropDown.hide(),this.isDropDownOpen=!1},t.prototype.updateOriginalInputValue=function(){"left"===this.config.unitDisplayPosition?this.$originalInput.val((this.selectedEntry?this.selectedEntry[this.config.unitValueProperty]:"")+this.formatAmount(this.getAmount(),this.config.decimalPrecision,this.config.decimalSeparator,"")):this.$originalInput.val(this.formatAmount(this.getAmount(),this.config.decimalPrecision,this.config.decimalSeparator,"")+(this.selectedEntry?this.selectedEntry[this.config.unitValueProperty]:""))},t.prototype.getAmount=function(){var t=this.getEditorValueNumberPart(!1);return 0===t.length&&this.config.allowNullAmount?null:0===t.length?0:parseInt(this.getEditorValueNumberPart(!0).replace(/\D/g,""))},t.prototype.isDropDownNeeded=function(){return"editable"==this.editingMode&&(this.config.entries&&this.config.entries.length>0||!this.usingDefaultQueryFunction||this.config.showTrigger)},t.prototype.setEditingMode=function(t){this.editingMode=t,this.$unitBox.removeClass("editable readonly disabled").addClass(this.editingMode),this.$editor.prop("readonly","editable"!==t),this.$editor.attr("tabindex","editable"===t?this.$originalInput.attr("tabindex"):"-1"),this.isDropDownNeeded()&&this.$dropDown.appendTo(this.$dropDownTargetElement)},t.prototype.selectUnit=function(t){var e=this;this.setSelectedEntry(this.entries.filter(function(i){return i[e.config.unitIdProperty]===t})[0],!1,null)},t.prototype.updateEntries=function(t){this.entries=t,this.$spinners.remove(),this.$spinners=i(),this.listBox.updateEntries(t)},t.prototype.getSelectedEntry=function(){if(null==this.selectedEntry)return null;var t=i.extend({},this.selectedEntry);return delete t._trEntryElement,t},t.prototype.setAmount=function(t){if(null!=t&&t!==Math.floor(t))throw"TrivialUnitBox: You must specify an integer amount!";null==t?this.config.allowNullAmount?this.$editor.val(""):this.$editor.val(this.formatAmount(0,this.config.decimalPrecision,this.config.decimalSeparator,"")):this.$editor.is(":focus")?this.$editor.val(this.formatAmount(t,this.config.decimalPrecision,this.config.decimalSeparator,"")):this.$editor.val(this.formatAmount(t,this.config.decimalPrecision,this.config.decimalSeparator,this.config.thousandsSeparator))},t.prototype.focus=function(){this.$editor.select()},t.prototype.getEditor=function(){return this.$editor[0]},t.prototype.destroy=function(){this.$originalInput.removeClass("tr-original-input").insertBefore(this.$unitBox),this.$unitBox.remove(),this.$dropDown.remove()},t.prototype.getMainDomElement=function(){return this.$unitBox[0]},t}();e.TrivialUnitBox=a});